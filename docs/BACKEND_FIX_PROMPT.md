# Backend Fix: Dev Notes AI Processing System

## Problem Statement

The dev notes AI processing system has been broken since **January 21, 2026**. Notes are being created and marked as "sent" successfully, but the background worker that converts them into dev tasks using AI is not running.

## Current Situation

### Database State
- **82 total dev notes** in the database
- **21 notes stuck in `status='sent'`** (awaiting AI processing)
- **50 notes with `status='processed'`** (successfully converted before Jan 21)
- **11 notes with `status='draft'`** (not yet sent)

### What's Working
1. ✅ Frontend creates notes successfully via `POST /api/dev-notes`
2. ✅ Frontend sends notes successfully via `POST /api/dev-notes/{noteId}/send`
3. ✅ Backend responds with `{status: 'SUCCESS', message: 'Note sent for processing'}`
4. ✅ Notes are marked with `status='sent'` in database
5. ✅ Socket.io connection works (but `dev-notes:updated` event not being emitted)

### What's Broken
1. ❌ Background worker/job that processes sent notes has not run since Jan 21
2. ❌ No new dev tasks created from notes since Jan 21, 2026
3. ❌ 21 notes stuck in "sent" status waiting for AI processing
4. ❌ No `dev-notes:updated` socket events being emitted

## Expected Behavior

### Note Processing Flow
1. User creates a note with title + content
2. User clicks "Send" → Frontend calls `POST /api/dev-notes/{noteId}/send`
3. Backend marks note as `status='sent'`
4. **Background worker picks up the note** (THIS IS BROKEN)
5. Worker uses AI (OpenAI/Anthropic) to analyze note content
6. AI generates one or more dev tasks from the note
7. Worker creates task(s) in `dev_tasks` table via `POST /api/dev-tasks`
8. Worker marks note as `status='processed'`
9. Backend emits `dev-notes:updated` socket event
10. Backend emits `dev-tasks:updated` socket event
11. Frontend auto-refreshes to show new tasks

### Task Fields Generated by AI
Based on existing tasks, AI should generate:
```javascript
{
  title: string,              // Short descriptive title
  description: string,        // Detailed description with file paths if applicable
  category: string,          // 'web' | 'mobile' | 'backend' | 'devops' | 'design' | 'qa' | 'documentation'
  taskType: 'task',          // Always 'task' for AI-generated
  priority: string,          // 'low' | 'medium' | 'high' | 'critical'
  status: 'pending',         // Always 'pending' initially
  parentId: null,            // Can be null unless creating subtasks
  epicId: null,              // Can be null
  sprint: null,              // Can be null
  createdBy: string,         // Email from note.createdBy
  estimatedMinutes: number   // AI estimate (optional)
}
```

## Files to Check/Fix

### Backend Structure (assumed)
```
backend/
├── routes/
│   └── dev-notes.routes.js          # API endpoints for notes
├── controllers/
│   └── dev-notes.controller.js      # Business logic
├── services/
│   └── dev-notes-processor.service.js   # AI processing service (LIKELY BROKEN)
├── workers/
│   └── dev-notes-worker.js          # Background job (LIKELY NOT RUNNING)
├── models/
│   └── dev-note.model.js            # Database model
└── jobs/
    └── process-dev-notes.job.js     # Scheduled job (CHECK THIS)
```

## What to Investigate

### 1. Check Background Worker Status
- Is the worker/job running? Check process manager (PM2, systemd, etc.)
- Check cron jobs or scheduled tasks
- Look for worker logs since Jan 21

### 2. Check AI Service Configuration
- OpenAI API key valid and not rate-limited?
- Anthropic API key valid? (if using Claude)
- Check API quotas and billing
- Check for 401/403/429 errors in logs

### 3. Check Database/Queue
- Are there any stuck jobs in a queue table?
- Check for database locks or connection issues
- Look for error logs around Jan 21, 17:57 UTC (when last tasks were created)

### 4. Check Error Logs
Look for errors containing:
- `dev-notes`
- `process` or `processing`
- `openai` or `anthropic`
- `queue` or `worker`
- Stack traces from Jan 21 onwards

### 5. Check Socket.io Emissions
The backend should emit:
```javascript
io.emit('dev-notes:updated', { noteId, status: 'processed' });
io.emit('dev-tasks:updated', { taskIds: [...] });
```
Verify these are being called after processing.

## Expected Fixes

### Fix 1: Restart Worker
If worker crashed, simply restart it:
```bash
# PM2 example
pm2 restart dev-notes-worker

# Or rebuild and restart
npm run build
pm2 restart all
```

### Fix 2: Fix AI API Configuration
```javascript
// Check environment variables
process.env.OPENAI_API_KEY    // Should be set
process.env.ANTHROPIC_API_KEY // Should be set (if using Claude)

// Verify in code
if (!process.env.OPENAI_API_KEY) {
  console.error('OPENAI_API_KEY not set!');
}
```

### Fix 3: Process Stuck Notes
After fixing the worker, reprocess stuck notes:
```sql
-- Find all sent notes
SELECT id, title, content, createdAt
FROM dev_notes
WHERE status = 'sent'
ORDER BY createdAt DESC;

-- Or trigger reprocessing via API
-- POST /api/dev-notes/reprocess-stuck
```

### Fix 4: Add Health Check Endpoint
```javascript
// GET /api/dev-notes/processing-status
{
  workerRunning: true,
  lastProcessedAt: "2026-02-07T03:00:00Z",
  pendingNotes: 0,
  processingNotes: 0,
  errorCount: 0
}
```

## Testing After Fix

1. **Verify worker is running**
   ```bash
   pm2 list | grep notes
   tail -f logs/dev-notes-worker.log
   ```

2. **Send a test note from frontend**
   - Create new note with content: "Test: Add console.log to main function"
   - Click Send
   - Watch backend logs for AI processing
   - Verify task appears in DevPortal within 30 seconds
   - Verify note status changes to 'processed'

3. **Check stuck notes are processed**
   - Query database for `status='sent'` (should be 0 after processing)
   - Verify all 21 stuck notes become 'processed'
   - Verify new tasks appear in DevPortal

4. **Verify socket events**
   - Open browser console during test
   - Should see: `[DevPortal] dev-notes:updated event received`
   - Should see: `[DevPortal] dev-tasks:updated event received`

## Sample AI Prompt (if rebuilding)

The AI processing service should use a prompt like:
```
You are a software development task planner. Given a developer's note, create one or more actionable dev tasks.

Note: {note.title}
Content: {note.content}

Generate tasks with:
1. Clear, specific titles
2. Detailed descriptions with file paths when applicable
3. Appropriate category (web/mobile/backend/devops/design/qa/documentation)
4. Priority based on urgency and impact
5. Estimated time in minutes

Return JSON array of tasks:
[{
  "title": "...",
  "description": "...",
  "category": "...",
  "priority": "...",
  "estimatedMinutes": 30
}]
```

## Questions to Answer

1. What background job system is being used? (Bull, Agenda, node-cron, AWS SQS, etc.)
2. Is there a queue table in the database?
3. What AI service is configured? (OpenAI GPT-4, Claude, etc.)
4. Are there any recent deployments or changes around Jan 21?
5. What error monitoring is in place? (Sentry, Datadog, CloudWatch?)

## Success Criteria

- ✅ Background worker running and processing notes
- ✅ All 21 stuck notes converted to tasks
- ✅ New notes convert to tasks within 30 seconds
- ✅ Socket events properly emitted
- ✅ No errors in logs
- ✅ Health check endpoint returns green status

## Contact Info

If you need clarification on the frontend implementation or note structure:
- Frontend notes panel: `web/src/components/dev/DevPortal.js`
- Note service: `web/src/services/devNoteService.js`
- Floating note button: `web/src/components/common/FloatingNoteButton.js`

---

**Last known good state:** January 21, 2026, 17:57 UTC
**First broken note:** January 22, 2026 (check notes created after this date)
**Current stuck notes:** 21 notes with `status='sent'`
